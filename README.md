# azure-terraform
Beginners Guide to Terraforming Azure

# Authentication
```bash
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
az login
az account list
# az account set -s <Subscription ID>
# az vm list-skus --location centralus --size Standard_A --output table
```

# Usage (flat file)
```bash
terraform init
# Module documentation: .terraform\modules\<random_id>\Azure-terraform-azurerm-compute-5b4096c\README.md

terraform plan \
	-var="vm_size=Standard_B1s" \
	-var="admin_password=My-long-pwd"

terraform apply \
	-var="vm_size=Standard_B1s" \
	-var="admin_password=My-long-pwd"

terraform destroy
```

# Usage (flat file + module)
- Rename `module.tf.disabled` > `module.tf`
- Check that you have default ssh key for linux VM `~/.ssh/id_rsa.pub`. If not - generate it:
```
ssh-keygen -t rsa -b 4096 -C username@example.com
```
- Apply terraform: see previous step "Usage (flat file)"

# Issues
## 1) Can't output public dynamic IP
```
        * module.linuxserver.output.public_ip_address: Resource 'azurerm_public_ip.vm' does not have attribute 'ip_address' for variable 'azurerm_public_ip.vm.*.ip_address'
```
Only static IP address is able to be written to the output, but not dynamic one
- For terraform 11 you can avoid the error by setting environment variable TF_WARN_OUTPUT_ERRORS=1
- Change "public_ip_address_allocation" from "dynamic" to "static"
## 2) The requested size is not available in location
```
Error: Error applying plan:
2 errors occurred:
        * azurerm_virtual_machine.site: 1 error occurred:
        * azurerm_virtual_machine.site: compute.VirtualMachinesClient#CreateOrUpdate: Failure responding to request: StatusCode=409 -- Original Error: autorest/azure: Service returned an error. Status=409 Code="SkuNotAvailable" Message="The requested size for resource '/subscriptions/9015a40c-7415-4779-ba69-4e1465441aca/resourceGroups/tfguide-Terraform-Azure-Beginners/providers/Microsoft.Compute/virtualMachines/catapp-site' is currently not available in location 'centralus' zones '' for subscription '9015a40c-7415-4779-ba69-4e1465441aca'. Please try another size or deploy to a different location or zones. See https://aka.ms/azureskunotavailable for details."
```
Not all VM sizes are available in some locations/zones
- List available VM sizes `az vm list-skus --location centralus --size Standard_A --output table`
## 3) Module can't find required file
```
Error: module.linuxserver.azurerm_virtual_machine.vm-linux: 1 error occurred:
        * module.linuxserver.azurerm_virtual_machine.vm-linux: file: open : no such file or directory in:
${file("${var.ssh_key}")}
```
- Create file or specify another path in variable
## 4) DNS record *.cloudapp.azure.com is already used by another public IP
```
Error: Error applying plan:
2 errors occurred:
        * module.linuxserver.azurerm_public_ip.vm: 1 error occurred:
        * azurerm_public_ip.vm: network.PublicIPAddressesClient#CreateOrUpdate: Failure responding to request: StatusCode=400 -- Original Error: autorest/azure: Service returned an error. Status=400 Code="DnsRecordInUse" Message="DNS record linsimplevmips.westus2.cloudapp.azure.com is already used by another public IP." 
```
- Specify globally unique name in variable
- Using `random` function add autogenerated suffix at the end of string
